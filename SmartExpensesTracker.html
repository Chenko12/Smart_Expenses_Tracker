<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×× ×”×œ ×”×•×¦××•×ª - ×’×¨×¡×” × ×§×™×™×” (×ª×•××š MAX/Cal/Isracard)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap');
        body { font-family: 'Assistant', sans-serif; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: bold; }
        .table-scroll-container { max-height: 500px; overflow-y: auto; position: relative; }
        .table-scroll-container thead { position: sticky; top: 0; z-index: 10; background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-10">

    <div class="max-w-7xl mx-auto py-8 px-4">
        
        <header class="bg-white p-6 rounded-2xl shadow-sm mb-6 border-b-4 border-blue-600 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">×× ×”×œ ×”×•×¦××•×ª ××™×©×™</h1>
                <p class="text-gray-500">×’×¨×¡×” × ×§×™×™×” ×œ×”×¤×¦×” - ×ª××™×›×” ×‘-MAX, Cal ×•-Isracard</p>
            </div>
            <button onclick="document.getElementById('excel-files').click()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition font-bold shadow-lg flex items-center gap-2">
                <span>ğŸ“‚</span> ×˜×¢×Ÿ ×§×‘×¦×™ ××§×¡×œ
            </button>
            <input type="file" id="excel-files" multiple accept=".xlsx, .xls" class="hidden"/>
        </header>

        <div id="dashboard-area" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 hidden">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col justify-center items-center text-center">
                <h3 class="text-gray-500 font-bold mb-2">×¡×”"×› ×”×•×¦××•×ª ×—×•×“×©×™</h3>
                <p id="total-sum-display" class="text-4xl font-black text-red-600 mb-2">0 â‚ª</p>
                <div class="text-xs text-gray-400 font-bold space-y-1">
                    <p id="total-rows-display">0 ×¢×¡×§××•×ª ××§×¡×œ</p>
                    <p id="total-fixed-display">0 ×”×•×¦××•×ª ×§×‘×•×¢×•×ª</p>
                </div>
            </div>
            <div class="md:col-span-2 bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex items-center justify-center">
                <div style="height: 250px; width: 100%; max-width: 500px;">
                    <canvas id="expensesChart"></canvas>
                </div>
            </div>
        </div>

        <div class="flex border-b border-gray-200 mb-0 bg-white rounded-t-lg px-4 gap-2 flex-wrap">
            <button onclick="switchTab('transactions')" id="tab-btn-transactions" class="py-4 px-6 tab-active transition">×ª× ×•×¢×•×ª ×•×¡×™×›×•×</button>
            <button onclick="switchTab('budget')" id="tab-btn-budget" class="py-4 px-6 text-gray-500 transition">ğŸ¯ ×¢××™×“×” ×‘×™×¢×“×™×</button>
            <button onclick="switchTab('fixed')" id="tab-btn-fixed" class="py-4 px-6 text-gray-500 transition">× ×™×”×•×œ ×”×•×¦××•×ª ×§×‘×•×¢×•×ª</button>
            <button onclick="switchTab('merchants')" id="tab-btn-merchants" class="py-4 px-6 text-gray-500 transition">× ×™×”×•×œ ×§×˜×’×•×¨×™×•×ª</button>
        </div>

        <div id="tab-transactions" class="bg-white rounded-b-xl shadow-sm border border-gray-200 p-0 overflow-hidden">
            <div class="grid grid-cols-1 lg:grid-cols-4 divide-x divide-x-reverse divide-gray-200">
                <div class="lg:col-span-3">
                    <div class="table-scroll-container">
                        <table class="w-full text-center border-collapse text-sm">
                            <thead>
                                <tr class="text-gray-600 border-b bg-gray-50">
                                    <th class="p-4">×ª××¨×™×š</th>
                                    <th class="p-4">×‘×™×ª ×¢×¡×§</th>
                                    <th class="p-4">×§×˜×’×•×¨×™×”</th>
                                    <th class="p-4 text-left">×¡×›×•×</th>
                                    <th class="p-4">×¤×¢×•×œ×•×ª</th>
                                </tr>
                            </thead>
                            <tbody id="data-table" class="divide-y divide-gray-100 text-gray-700">
                                <tr><td colspan="5" class="p-20 text-center text-gray-400 italic text-lg">×˜×¢×Ÿ ×§×‘×¦×™× ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="lg:col-span-1 bg-slate-50/50 p-4">
                    <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">×”×•×¦××•×ª ×§×‘×•×¢×•×ª</h3>
                    <div id="sidebar-fixed-list" class="space-y-2 text-xs"></div>
                </div>
            </div>

            <div class="border-t-4 border-gray-100 p-8 bg-gray-50/30">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“Š ×¡×™×›×•× ×ª×§×¦×™×‘ ××•×œ ×‘×™×¦×•×¢</h3>
                <div class="overflow-x-auto rounded-lg border bg-white">
                    <table class="w-full text-center text-sm">
                        <thead class="bg-gray-100 font-bold">
                            <tr>
                                <th class="p-4">×§×˜×’×•×¨×™×”</th>
                                <th class="p-4">×ª×§×¦×™×‘ ×™×¢×“</th>
                                <th class="p-4">×‘×™×¦×•×¢ ×‘×¤×•×¢×œ</th>
                                <th class="p-4">×”×¤×¨×©</th>
                                <th class="p-4 w-1/4">×¡×˜×˜×•×¡</th>
                            </tr>
                        </thead>
                        <tbody id="budget-summary-table" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-budget" class="hidden bg-white p-8 rounded-b-xl shadow-sm border border-gray-200">
            <div id="budget-inputs-container" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
            <div class="mt-8 text-center">
                <button onclick="saveBudgets()" class="bg-blue-600 text-white font-bold py-3 px-12 rounded-lg hover:bg-blue-700 transition">×©××•×¨ ×™×¢×“×™×</button>
            </div>
        </div>

        <div id="tab-fixed" class="hidden bg-white p-8 rounded-b-xl shadow-sm border border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="bg-gray-50 p-6 rounded-xl border space-y-4">
                    <input type="text" id="fixed-name" placeholder="×©× ×”×”×•×¦××”" class="w-full p-2 border rounded">
                    <input type="number" id="fixed-amount" placeholder="×¡×›×•× â‚ª" class="w-full p-2 border rounded">
                    <select id="fixed-category" class="w-full p-2 border rounded bg-white"></select>
                    <button onclick="addFixedExpense()" class="w-full bg-green-600 text-white font-bold py-2 rounded">×”×•×¡×£</button>
                </div>
                <div class="md:col-span-2">
                    <table class="w-full text-center text-sm border">
                        <thead class="bg-gray-100"><tr><th>×©×</th><th>×§×˜×’×•×¨×™×”</th><th>×¡×›×•×</th><th>××—×§</th></tr></thead>
                        <tbody id="fixed-management-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-merchants" class="hidden bg-white p-6 rounded-b-xl shadow-sm border border-gray-200">
            <table class="w-full text-center border-collapse">
                <thead class="bg-slate-50 border-b"><tr><th>×‘×™×ª ×¢×¡×§</th><th>×§×˜×’×•×¨×™×”</th><th>×¤×¢×•×œ×”</th></tr></thead>
                <tbody id="merchants-list"></tbody>
            </table>
        </div>

    </div>

    <div id="category-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl w-96 text-center">
            <h3 class="text-xl font-bold mb-4">×©×™×•×š ×¢×¡×§ ×œ×§×˜×’×•×¨×™×”</h3>
            <input type="text" id="cat-merchant-name" class="w-full p-2 border rounded bg-gray-100 mb-4 text-center font-bold" readonly />
            <select id="cat-selection" class="w-full p-3 border rounded-lg mb-4 text-center"></select>
            <div class="flex gap-3">
                <button onclick="saveMerchantMapping()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">×©××•×¨</button>
                <button onclick="closeModal()" class="flex-1 bg-gray-200 py-2 rounded-lg font-bold">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <script>
        const ALL_CATEGORIES = [
            "××–×•×Ÿ ×•×¡×•×¤×¨", "×¤× ××™ ×•×‘×™×œ×•×™×", "×§× ×™×•×ª ×•×‘×™×’×•×“", "×ª×—×–×•×§×ª ×”×‘×™×ª / ×©×›''×“",
            "×ª×—×‘×•×¨×” ×•×¨×›×‘", "×‘×¨×™××•×ª", "×¤××¨×", "×‘×™×˜×•×—×™×", "×—×™× ×•×š", "×”×œ×•×•××•×ª", "×¢××œ×•×ª", "×—×©×‘×•× ×•×ª", "××—×¨"
        ];

        // EMPTY STARTING DATA
        let merchantsMapping = {};
        let fixedExpenses = [];
        let budgetLimits = {};
        let currentLoadedData = [];
        let chartInstance = null;

        function escapeStr(str) {
            if (!str) return "";
            return str.replace(/'/g, "\\'").replace(/"/g, "&quot;");
        }

        function init() {
            const options = ALL_CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('fixed-category').innerHTML = options;
            document.getElementById('cat-selection').innerHTML = options;
            renderBudgetInputs();
            renderFixedExpensesTable();
            renderSidebarFixedList();
            renderBudgetSummaryTable();
        }

        function switchTab(tab) {
            ['transactions', 'merchants', 'fixed', 'budget'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                document.getElementById(`tab-btn-${t}`).className = 'py-4 px-6 text-gray-500 transition';
            });
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-btn-${tab}`).className = 'py-4 px-6 tab-active transition';
            if (tab === 'merchants') renderMerchantsList();
            if (tab === 'transactions') { renderTransactions(); renderBudgetSummaryTable(); }
        }

        // --- EXCEL PARSER (Supports MAX, Cal, Isracard) ---
        document.getElementById('excel-files').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            let combined = [];
            const datePattern = /^\d{1,2}[\/.-]\d{1,2}[\/.-]\d{2,4}$/;

            for (const file of files) {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { cellDates: true });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rawRows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

                // Detect Format based on Row 4 headers
                let colMapping = { date: 0, business: 1, amount: 3 }; // Default (Cal/Isracard logic)
                const row4 = rawRows[3] || [];
                
                if (row4.some(cell => String(cell).includes("×ª××¨×™×š ×¢×¡×§×”"))) {
                    // MAX Format Detection
                    colMapping = {
                        date: row4.findIndex(c => String(c).includes("×ª××¨×™×š ×¢×¡×§×”")),
                        business: row4.findIndex(c => String(c).includes("×©× ×‘×™×ª ×”×¢×¡×§")),
                        amount: row4.findIndex(c => String(c).includes("×¡×›×•× ×—×™×•×‘"))
                    };
                }

                let active = false;
                for (let i = 0; i < rawRows.length; i++) {
                    const row = rawRows[i];
                    if (!row || row.length < 2) continue;
                    
                    const dateCell = row[colMapping.date];
                    const isDate = (dateCell instanceof Date) || datePattern.test(String(dateCell).trim());

                    if (isDate) {
                        active = true;
                        let dateStr = (dateCell instanceof Date) 
                            ? `${dateCell.getDate()}/${dateCell.getMonth() + 1}/${dateCell.getFullYear()}`
                            : String(dateCell).trim().replace(/-/g, '/');
                        
                        const businessName = String(row[colMapping.business]).trim();
                        const clean = (val) => {
                            if (val === undefined || val === null || val === "") return NaN;
                            return parseFloat(String(val).replace(/[^\d.-]/g, ''));
                        };
                        
                        let amountVal = 0;
                        if (colMapping.amount === 3) { 
                            // Cal/Isracard logic: check Column E, then D
                            let valE = clean(row[4]); 
                            let valD = clean(row[3]); 
                            if (!isNaN(valE) && String(row[4]) !== "") amountVal = valE;
                            else if (!isNaN(valD) && String(row[3]) !== "") amountVal = valD;
                        } else {
                            // MAX/Specific logic
                            amountVal = clean(row[colMapping.amount]);
                        }

                        if (!isNaN(amountVal) && amountVal !== 0) {
                            combined.push({ date: dateStr, business: businessName, amount: amountVal });
                        }
                    } else if (active && i > 10 && row.length < 2) break; 
                }
            }
            currentLoadedData = combined;
            document.getElementById('dashboard-area').classList.remove('hidden');
            updateDashboard();
            renderTransactions();
            renderBudgetSummaryTable();
        });

        function renderBudgetSummaryTable() {
            const tbody = document.getElementById('budget-summary-table');
            const actuals = {};
            ALL_CATEGORIES.forEach(c => actuals[c] = 0);

            currentLoadedData.forEach(item => {
                let cat = merchantsMapping[item.business] || '××—×¨';
                if (!ALL_CATEGORIES.includes(cat)) cat = '××—×¨';
                actuals[cat] += item.amount;
            });

            fixedExpenses.forEach(item => {
                let cat = item.category || '××—×¨';
                if (!ALL_CATEGORIES.includes(cat)) cat = '××—×¨';
                actuals[cat] += item.amount;
            });

            tbody.innerHTML = ALL_CATEGORIES.map(cat => {
                const budget = budgetLimits[cat] || 0;
                const actual = actuals[cat];
                const diff = budget - actual;
                const percent = budget > 0 ? Math.min((actual / budget) * 100, 100) : (actual > 0 ? 100 : 0);
                const barColor = percent >= 100 ? 'bg-red-500' : (percent > 85 ? 'bg-yellow-400' : 'bg-green-500');

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4 font-bold">${cat}</td>
                        <td class="p-4 font-mono">${budget.toLocaleString()} â‚ª</td>
                        <td class="p-4 font-mono font-bold">${actual.toLocaleString()} â‚ª</td>
                        <td class="p-4 font-mono ${diff < 0 ? 'text-red-600' : 'text-green-600'}">${diff.toLocaleString()} â‚ª</td>
                        <td class="p-4">
                            <div class="w-full bg-gray-200 rounded-full h-2"><div class="${barColor} h-2 rounded-full" style="width: ${percent}%"></div></div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateDashboard() {
            const tExcel = currentLoadedData.reduce((s, i) => s + i.amount, 0);
            const tFixed = fixedExpenses.reduce((s, i) => s + i.amount, 0);
            document.getElementById('total-sum-display').innerText = (tExcel + tFixed).toLocaleString() + ' â‚ª';
            document.getElementById('total-rows-display').innerText = `${currentLoadedData.length} ×¢×¡×§××•×ª ××§×¡×œ`;
            document.getElementById('total-fixed-display').innerText = `${fixedExpenses.length} ×”×•×¦××•×ª ×§×‘×•×¢×•×ª`;

            const stats = {};
            currentLoadedData.forEach(i => { const c = merchantsMapping[i.business] || '××—×¨'; stats[c] = (stats[c] || 0) + i.amount; });
            fixedExpenses.forEach(i => { stats[i.category] = (stats[i.category] || 0) + i.amount; });

            if (chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('expensesChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: Object.keys(stats), datasets: [{ data: Object.values(stats), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }

        function renderTransactions() {
            const tbody = document.getElementById('data-table');
            if (currentLoadedData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-20 text-center text-gray-400 italic text-lg">×˜×¢×Ÿ ×§×‘×¦×™× ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×...</td></tr>';
                return;
            }
            tbody.innerHTML = currentLoadedData.map((item, idx) => {
                const cat = merchantsMapping[item.business];
                return `
                <tr class="hover:bg-blue-50">
                    <td class="p-4">${item.date}</td>
                    <td class="p-4 font-bold">${item.business}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded-full text-xs font-bold ${cat ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-400'}">${cat || '×œ×œ× ×©×™×•×š'}</span></td>
                    <td class="p-4 font-bold text-left ${item.amount > 0 ? 'text-red-600' : 'text-green-600'}">${item.amount.toLocaleString()} â‚ª</td>
                    <td class="p-4">${!cat ? `<button onclick="openMappingModal(${idx})" class="text-blue-600 font-bold">×©×™×™×š ×§×˜×’×•×¨×™×”</button>` : ''}</td>
                </tr>`;
            }).join('');
        }

        function renderBudgetInputs() {
            document.getElementById('budget-inputs-container').innerHTML = ALL_CATEGORIES.map(cat => `
                <div><label class="block text-xs font-bold mb-1">${cat}</label>
                <input type="number" data-cat="${cat}" value="${budgetLimits[cat] || 0}" class="budget-input w-full p-2 border rounded text-center font-mono focus:ring-2 focus:ring-blue-500 outline-none"></div>
            `).join('');
        }

        function saveBudgets() {
            document.querySelectorAll('.budget-input').forEach(i => budgetLimits[i.dataset.cat] = parseFloat(i.value) || 0);
            renderBudgetSummaryTable();
            updateDashboard();
            alert('×”×ª×§×¦×™×‘ × ×©××¨ ×‘×”×¦×œ×—×”!');
        }

        function addFixedExpense() {
            const name = document.getElementById('fixed-name').value;
            const amount = parseFloat(document.getElementById('fixed-amount').value);
            const category = document.getElementById('fixed-category').value;
            if (name && !isNaN(amount)) {
                fixedExpenses.push({ name, amount, category });
                renderFixedExpensesTable(); renderSidebarFixedList(); updateDashboard(); renderBudgetSummaryTable();
                document.getElementById('fixed-name').value = ''; document.getElementById('fixed-amount').value = '';
            }
        }

        function renderFixedExpensesTable() {
            document.getElementById('fixed-management-list').innerHTML = fixedExpenses.map((i, idx) => `
                <tr class="border-b"><td class="p-2 font-bold">${i.name}</td><td class="p-2">${i.category}</td><td class="p-2 font-mono">${i.amount.toLocaleString()} â‚ª</td>
                <td class="p-2"><button onclick="fixedExpenses.splice(${idx},1);renderFixedExpensesTable();updateDashboard();renderBudgetSummaryTable();" class="text-red-500">ğŸ—‘</button></td></tr>
            `).join('');
        }

        function renderSidebarFixedList() {
            document.getElementById('sidebar-fixed-list').innerHTML = fixedExpenses.map(i => `
                <div class="flex justify-between border-b border-dashed py-1"><span><b>${i.name}</b> (${i.category})</span><span class="font-mono">${i.amount.toLocaleString()} â‚ª</span></div>
            `).join('');
        }

        function openMappingModal(idx) { 
            document.getElementById('cat-merchant-name').value = currentLoadedData[idx].business; 
            document.getElementById('category-modal').classList.remove('hidden'); 
        }

        function closeModal() { document.getElementById('category-modal').classList.add('hidden'); }

        function saveMerchantMapping() {
            const biz = document.getElementById('cat-merchant-name').value;
            const cat = document.getElementById('cat-selection').value;
            merchantsMapping[biz] = cat;
            closeModal(); updateDashboard(); renderTransactions(); renderBudgetSummaryTable();
        }

        function renderMerchantsList() {
            const keys = Object.keys(merchantsMapping);
            if (keys.length === 0) {
                document.getElementById('merchants-list').innerHTML = '<tr><td colspan="3" class="p-10 text-gray-400 italic">××™×Ÿ ×©×™×•×›×™× ×©××•×¨×™×</td></tr>';
                return;
            }
            document.getElementById('merchants-list').innerHTML = keys.map(name => {
                const safeName = escapeStr(name);
                return `
                <tr class="border-b">
                    <td class="p-2 font-bold">${name}</td>
                    <td class="p-2"><span class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs">${merchantsMapping[name]}</span></td>
                    <td class="p-2"><button onclick="removeMerchant('${safeName}')" class="text-red-400 font-bold hover:text-red-600">××—×§</button></td>
                </tr>`;
            }).join('');
        }

        function removeMerchant(name) {
            if (confirm('×œ××—×•×§ ××ª ×©×™×•×š ×‘×™×ª ×”×¢×¡×§: ' + name + '?')) {
                delete merchantsMapping[name];
                renderMerchantsList();
                updateDashboard();
            }
        }

        init();
    </script>
</body>
</html>